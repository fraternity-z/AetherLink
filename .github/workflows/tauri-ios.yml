name: Tauri iOS Build

on:
  push:
    branches: [ main, master ]
  workflow_dispatch:

jobs:
  build:
    runs-on: macos-latest
    steps:
      - uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '22'
          cache: 'npm'
      
      - name: Setup Rust
        uses: dtolnay/rust-toolchain@stable
        with:
          targets: aarch64-apple-ios,x86_64-apple-ios,aarch64-apple-ios-sim
      
      - name: Setup Xcode
        uses: maxim-lobanov/setup-xcode@v1
        with:
          xcode-version: latest-stable

      - name: Install dependencies
        run: npm ci || npm install --legacy-peer-deps
      
      - name: Build frontend
        run: npm run build
      
      - name: Install Tauri CLI
        run: npm install -g @tauri-apps/cli@latest
      
      - name: Initialize iOS Project
        run: |
          cd src-tauri
          # 初始化 iOS 项目（创建 Xcode 项目）
          tauri ios init
      
      - name: Build iOS App (Unsigned)
        run: |
          cd src-tauri
          # 设置为不签名模式
          export APPLE_DEVELOPMENT_TEAM="-"
          export APPLE_SIGNING_IDENTITY="-"
          # 构建 Release 版本（不打开 Xcode）
          echo "Starting Tauri iOS build..."
          tauri ios build --open false || {
            echo "❌ Tauri iOS build failed!"
            echo "Checking for error logs..."
            if [ -d "gen/apple" ]; then
              echo "=== Apple directory contents ==="
              find gen/apple -type f -name "*.log" -exec echo "Found log: {}" \; -exec cat {} \;
            fi
            exit 1
          }
      
      - name: Check Build Output
        run: |
          echo "Checking build directory structure..."
          if [ -d "src-tauri/gen/apple" ]; then
            echo "✓ Apple directory exists"
            ls -la src-tauri/gen/apple/
            if [ -d "src-tauri/gen/apple/build" ]; then
              echo "✓ Build directory exists"
              ls -la src-tauri/gen/apple/build/
              if [ -d "src-tauri/gen/apple/build/Release-iphoneos" ]; then
                echo "✓ Release-iphoneos directory exists"
                ls -la src-tauri/gen/apple/build/Release-iphoneos/
              else
                echo "✗ Release-iphoneos directory not found"
                echo "Available directories in build:"
                ls -la src-tauri/gen/apple/build/ || echo "Build directory empty"
                exit 1
              fi
            else
              echo "✗ Build directory not found"
              exit 1
            fi
          else
            echo "✗ Apple directory not found"
            exit 1
          fi
      
      - name: Package Unsigned IPA
        if: success()
        run: |
          cd src-tauri/gen/apple/build/Release-iphoneos
          # 查找 .app 文件
          APP_NAME=$(ls -d *.app | head -n 1)
          if [ -n "$APP_NAME" ]; then
            echo "Found app: $APP_NAME"
            # 创建 Payload 目录
            mkdir -p Payload
            cp -r "$APP_NAME" Payload/
            # 打包为 IPA
            zip -r "${APP_NAME%.app}-unsigned.ipa" Payload
            mv "${APP_NAME%.app}-unsigned.ipa" ../../../../../
            echo "IPA created: ${APP_NAME%.app}-unsigned.ipa"
          else
            echo "No .app file found"
            exit 1
          fi
      
      - name: Upload Unsigned IPA
        uses: actions/upload-artifact@v4
        with:
          name: ios-unsigned-ipa
          path: src-tauri/*-unsigned.ipa