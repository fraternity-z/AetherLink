name: Tauri iOS Build

on:
  push:
    branches: [ main, master ]
  workflow_dispatch:

permissions:
  contents: write

jobs:
  build-ios:
    runs-on: macos-14
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
      
      - name: Setup Rust
        uses: dtolnay/rust-toolchain@stable
        with:
          targets: aarch64-apple-ios,x86_64-apple-ios,aarch64-apple-ios-sim
      
      - name: Rust cache
        uses: swatinem/rust-cache@v2
        with:
          workspaces: './src-tauri -> target'
      
      - name: Setup Xcode
        uses: maxim-lobanov/setup-xcode@v1
        with:
          xcode-version: '16.1'  # 项目格式 77 需要 Xcode 16+，使用可用的 16.1  

      - name: Install dependencies
        run: npm ci || npm install --legacy-peer-deps
      
      - name: Build frontend
        run: npm run build
      
      - name: Verify iOS project exists
        run: |
          # 检查 iOS 项目是否存在（应该已经在代码库中）
          if [ -d "src-tauri/gen/apple" ]; then
            echo "✅ iOS 项目已存在，使用现有源码"
            echo "=== Xcode 项目信息 ==="
            ls -la src-tauri/gen/apple/
            find src-tauri/gen/apple -name "*.xcodeproj" -maxdepth 1
          else
            echo "❌ 错误：iOS 项目不存在！"
            echo "请先运行 'Initialize Tauri iOS Project' workflow 初始化项目"
            echo "或者手动运行: npx @tauri-apps/cli ios init"
            exit 1
          fi
      
      - name: Disable code signing (for CI build)
        run: |
          cd src-tauri/gen/apple
          # 禁用代码签名
          /usr/libexec/PlistBuddy -c "Set :objects:PRODUCT_BUNDLE_IDENTIFIER com.aetherlink.app" aetherlink.xcodeproj/project.pbxproj || true
          
          # 使用 sed 修改项目文件，禁用代码签名
          sed -i '' 's/CODE_SIGN_STYLE = Automatic;/CODE_SIGN_STYLE = Manual;/g' aetherlink.xcodeproj/project.pbxproj
          sed -i '' 's/CODE_SIGN_IDENTITY = "Apple Development";/CODE_SIGN_IDENTITY = "";/g' aetherlink.xcodeproj/project.pbxproj
          sed -i '' 's/DEVELOPMENT_TEAM = [^;]*;/DEVELOPMENT_TEAM = "";/g' aetherlink.xcodeproj/project.pbxproj
          
          echo "✅ 已禁用代码签名"
      
      - name: Build iOS App with xcodebuild
        run: |
          cd src-tauri/gen/apple
          
          # 构建 iOS 应用（不签名）
          xcodebuild archive \
            -project aetherlink.xcodeproj \
            -scheme aetherlink_iOS \
            -configuration Release \
            -archivePath ./build/App.xcarchive \
            -destination generic/platform=iOS \
            CODE_SIGNING_ALLOWED=NO \
            CODE_SIGN_IDENTITY="" \
            PROVISIONING_PROFILE="" \
            DEVELOPMENT_TEAM=""
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      
      - name: Export IPA from archive
        run: |
          cd src-tauri/gen/apple
          
          # 检查归档是否存在
          if [ ! -d "./build/App.xcarchive" ]; then
            echo "❌ Archive 不存在"
            exit 1
          fi
          
          # 从 archive 中提取 app 并打包成 IPA
          echo "提取应用..."
          if [ -d "./build/App.xcarchive/Products/Applications" ]; then
            mkdir -p ./build/Payload
            cp -r ./build/App.xcarchive/Products/Applications/*.app ./build/Payload/
            cd ./build
            zip -r AetherLink-iOS-unsigned.ipa Payload/
            echo "✅ IPA 创建成功"
            ls -lh AetherLink-iOS-unsigned.ipa
          else
            echo "❌ 无法在 archive 中找到 app"
            ls -la ./build/App.xcarchive/
            exit 1
          fi
      
      - name: Upload IPA artifact
        run: |
          # 创建输出目录
          mkdir -p ios-artifacts
          
          # 复制 IPA 文件
          if [ -f "src-tauri/gen/apple/build/AetherLink-iOS-unsigned.ipa" ]; then
            cp src-tauri/gen/apple/build/AetherLink-iOS-unsigned.ipa ios-artifacts/
            echo "✅ IPA 文件已复制"
          else
            echo "❌ IPA 文件不存在"
            exit 1
          fi
          
          # 列出文件
          echo "=== IPA 文件信息 ==="
          ls -lh ios-artifacts/
      
      - name: Upload iOS artifacts
        uses: actions/upload-artifact@v4
        with:
          name: tauri-ios-ipa
          path: ios-artifacts/*.ipa
          if-no-files-found: warn
          retention-days: 30
      
      - name: Create build summary
        run: |
          echo "## Tauri iOS " >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### " >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
          ls -lh ios-artifacts/ || echo "" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### " >> $GITHUB_STEP_SUMMARY
          echo "Actions " >> $GITHUB_STEP_SUMMARY