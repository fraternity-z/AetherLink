name: Tauri iOS Build

on:
  push:
    branches: [ main, master ]
  workflow_dispatch:

jobs:
  build:
    runs-on: macos-latest
    steps:
      - uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '22'
          cache: 'npm'
      
      - name: Setup Rust
        uses: dtolnay/rust-toolchain@stable
        with:
          targets: aarch64-apple-ios,x86_64-apple-ios,aarch64-apple-ios-sim
      
      - name: Setup Xcode
        uses: maxim-lobanov/setup-xcode@v1
        with:
          # 使用 16.0 稳定版本（runner 上可用的最低版本）
          xcode-version: '16.0'

      - name: Install dependencies
        run: npm ci || npm install --legacy-peer-deps
      
      - name: Build frontend
        run: npm run build
      
      - name: Install Tauri CLI
        run: npm install -g @tauri-apps/cli@latest
      
      - name: Initialize iOS Project
        run: |
          cd src-tauri
          # 初始化 iOS 项目（创建 Xcode 项目）
          tauri ios init
      
      - name: Build iOS App (Debugging - Unsigned)
        run: |
          cd src-tauri
          # 设置为开发模式（允许无签名构建）
          export APPLE_DEVELOPMENT_TEAM="-"
          export APPLE_SIGNING_IDENTITY="-"
          # 使用 debugging 导出方法构建（CI/CD 无签名）
          echo "Starting Tauri iOS build (debugging export)..."
          tauri ios build --export-method debugging || {
            echo "❌ Tauri iOS build failed!"
            echo "Checking for error logs..."
            if [ -d "gen/apple" ]; then
              echo "=== Apple directory contents ==="
              find gen/apple -type f -name "*.log" -exec echo "Found log: {}" \; -exec cat {} \;
            fi
            exit 1
          }
      
      - name: Check Build Output
        run: |
          echo "Checking build directory structure..."
          if [ -d "src-tauri/gen/apple" ]; then
            echo "✓ Apple directory exists"
            ls -la src-tauri/gen/apple/
            if [ -d "src-tauri/gen/apple/build" ]; then
              echo "✓ Build directory exists"
              echo "=== Build directory contents ==="
              find src-tauri/gen/apple/build -type f -name "*.ipa" -o -name "*.app" | head -20
              echo ""
              echo "=== All build artifacts ==="
              ls -laR src-tauri/gen/apple/build/ | head -100
            else
              echo "✗ Build directory not found"
              exit 1
            fi
          else
            echo "✗ Apple directory not found"
            exit 1
          fi
      
      - name: Find and Copy IPA
        if: success()
        run: |
          # 根据文档，IPA 应该在 src-tauri/gen/apple/build/arm64/$APPNAME.ipa
          # 或者其他构建目录中
          echo "Searching for IPA files..."
          IPA_PATH=$(find src-tauri/gen/apple/build -name "*.ipa" -type f | head -n 1)
          
          if [ -n "$IPA_PATH" ]; then
            echo "✓ Found IPA: $IPA_PATH"
            cp "$IPA_PATH" src-tauri/AetherLink-unsigned.ipa
            echo "IPA copied to src-tauri/AetherLink-unsigned.ipa"
          else
            echo "✗ No IPA file found, trying to create from .app..."
            APP_PATH=$(find src-tauri/gen/apple/build -name "*.app" -type d | head -n 1)
            
            if [ -n "$APP_PATH" ]; then
              echo "✓ Found .app: $APP_PATH"
              APP_NAME=$(basename "$APP_PATH")
              WORK_DIR=$(mktemp -d)
              mkdir -p "$WORK_DIR/Payload"
              cp -r "$APP_PATH" "$WORK_DIR/Payload/"
              cd "$WORK_DIR"
              zip -r AetherLink-unsigned.ipa Payload
              mv AetherLink-unsigned.ipa "$GITHUB_WORKSPACE/src-tauri/"
              cd "$GITHUB_WORKSPACE"
              rm -rf "$WORK_DIR"
              echo "IPA created from .app"
            else
              echo "✗ Neither .ipa nor .app file found"
              exit 1
            fi
          fi
      
      - name: Upload Unsigned IPA
        uses: actions/upload-artifact@v4
        with:
          name: ios-unsigned-ipa
          path: src-tauri/*-unsigned.ipa