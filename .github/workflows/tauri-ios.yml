name: Tauri iOS Build

on:
  push:
    branches: [ main, master ]
  workflow_dispatch:

permissions:
  contents: write

jobs:
  build-ios:
    runs-on: macos-14
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
      
      - name: Setup Rust
        uses: dtolnay/rust-toolchain@stable
        with:
          targets: aarch64-apple-ios,x86_64-apple-ios,aarch64-apple-ios-sim
      
      - name: Rust cache
        uses: swatinem/rust-cache@v2
        with:
          workspaces: './src-tauri -> target'
      
      - name: Setup Xcode
        uses: maxim-lobanov/setup-xcode@v1
        with:
          xcode-version: '16.1'  # 项目格式 77 需要 Xcode 16+，使用可用的 16.1  

      - name: Install dependencies
        run: npm ci || npm install --legacy-peer-deps
      
      - name: Build frontend
        run: npm run build
      
      - name: Verify iOS project exists
        run: |
          # 检查 iOS 项目是否存在（应该已经在代码库中）
          if [ -d "src-tauri/gen/apple" ]; then
            echo "✅ iOS 项目已存在，使用现有源码"
            echo "=== Xcode 项目信息 ==="
            ls -la src-tauri/gen/apple/
            find src-tauri/gen/apple -name "*.xcodeproj" -maxdepth 1
          else
            echo "❌ 错误：iOS 项目不存在！"
            echo "请先运行 'Initialize Tauri iOS Project' workflow 初始化项目"
            echo "或者手动运行: npx @tauri-apps/cli ios init"
            exit 1
          fi
      
      - name: Build iOS App with Tauri CLI (no signing)
        run: |
          # 使用 Tauri CLI 构建 iOS，但不打开 Xcode
          # 这会正确处理 Rust 编译和前端资源打包
          npm run tauri ios build -- --ci || {
            echo "❌ Tauri iOS 构建失败"
            echo "尝试查找构建产物..."
            find src-tauri/gen/apple -name "*.app" -o -name "*.ipa" || true
            exit 1
          }
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          # 禁用代码签名
          APPLE_DEVELOPMENT_TEAM: ""
          APPLE_SIGNING_IDENTITY: ""
      
      - name: Find and package IPA
        run: |
          echo "=== 查找 IPA 文件 ==="
          find src-tauri -name "*.ipa" -type f || echo "未找到 IPA 文件"
          find src-tauri -name "*.app" -type d || echo "未找到 APP 文件"
          
          # 创建输出目录
          mkdir -p ios-artifacts
          
          # 查找并复制 IPA 文件
          IPA_FILE=$(find src-tauri/gen/apple -name "*.ipa" -type f | head -n 1)
          
          if [ -n "$IPA_FILE" ] && [ -f "$IPA_FILE" ]; then
            echo "✅ 找到 IPA: $IPA_FILE"
            cp "$IPA_FILE" ios-artifacts/AetherLink-iOS.ipa
            ls -lh ios-artifacts/AetherLink-iOS.ipa
          else
            echo "⚠️ 未找到 IPA，尝试从 .app 创建"
            APP_FILE=$(find src-tauri/gen/apple -name "*.app" -type d | grep -v "Build/Intermediates" | head -n 1)
            
            if [ -n "$APP_FILE" ] && [ -d "$APP_FILE" ]; then
              echo "✅ 找到 APP: $APP_FILE"
              mkdir -p ios-artifacts/Payload
              cp -r "$APP_FILE" ios-artifacts/Payload/
              cd ios-artifacts
              zip -r AetherLink-iOS.ipa Payload/
              rm -rf Payload/
              echo "✅ IPA 创建成功"
              ls -lh AetherLink-iOS.ipa
            else
              echo "❌ 无法找到 .app 或 .ipa 文件"
              echo "=== src-tauri/gen/apple 目录结构 ==="
              ls -R src-tauri/gen/apple/ || true
              exit 1
            fi
          fi
      
      - name: Upload iOS artifacts
        uses: actions/upload-artifact@v4
        with:
          name: tauri-ios-ipa
          path: ios-artifacts/*.ipa
          if-no-files-found: warn
          retention-days: 30
      
      - name: Create build summary
        run: |
          echo "## Tauri iOS " >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### " >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
          ls -lh ios-artifacts/ || echo "" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### " >> $GITHUB_STEP_SUMMARY
          echo "Actions " >> $GITHUB_STEP_SUMMARY