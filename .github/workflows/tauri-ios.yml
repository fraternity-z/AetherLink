name: Tauri iOS Build

on:
  push:
    branches: [ main, master ]
  workflow_dispatch:

permissions:
  contents: write

jobs:
  build-ios:
    runs-on: macos-14
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
      
      - name: Setup Rust
        uses: dtolnay/rust-toolchain@stable
        with:
          targets: aarch64-apple-ios,x86_64-apple-ios,aarch64-apple-ios-sim
      
      - name: Rust cache
        uses: swatinem/rust-cache@v2
        with:
          workspaces: './src-tauri -> target'
      
      - name: Setup Xcode
        uses: maxim-lobanov/setup-xcode@v1
        with:
          xcode-version: '15.4'  

      - name: Install dependencies
        run: npm ci || npm install --legacy-peer-deps
      
      - name: Build frontend
        run: npm run build
      
      - name: Initialize Tauri iOS project (if not exists)
        run: |
          # Tauri v2 使用 apple/ 目录
          if [ ! -d "src-tauri/gen/apple" ]; then
            echo "初始化 Tauri iOS 项目..."
            npx @tauri-apps/cli ios init || echo "iOS init failed, may already exist"
          else
            echo "✅ iOS 项目已存在"
          fi
      
      - name: Build iOS App (直接使用 Tauri CLI)
        run: |
          npm run tauri ios build
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      
      - name: Find and upload IPA
        run: |
          echo "Searching for IPA files..."
          # Tauri v2 使用 apple/ 目录
          find src-tauri/gen/apple -name "*.ipa" -type f || echo "未在 apple/ 目录找到 IPA"
          find src-tauri/gen -name "*.ipa" -type f || echo "未在 gen/ 目录找到任何 IPA"
          
          # 创建输出目录
          mkdir -p ios-artifacts
          
          # 复制所有 IPA 文件（搜索整个 gen 目录）
          find src-tauri/gen -name "*.ipa" -type f -exec cp {} ios-artifacts/ \; || echo "未找到 IPA 文件"
          
          # 列出找到的文件
          echo "=== 找到的 IPA 文件 ==="
          ls -lh ios-artifacts/ || echo "ios-artifacts 目录为空"
      
      - name: Upload iOS artifacts
        uses: actions/upload-artifact@v4
        with:
          name: tauri-ios-ipa
          path: ios-artifacts/*.ipa
          if-no-files-found: warn
          retention-days: 30
      
      - name: Create build summary
        run: |
          echo "## Tauri iOS " >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### " >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
          ls -lh ios-artifacts/ || echo "" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### " >> $GITHUB_STEP_SUMMARY
          echo "Actions " >> $GITHUB_STEP_SUMMARY