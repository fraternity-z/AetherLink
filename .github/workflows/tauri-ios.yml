name: Tauri iOS Build (No Signing)

# æ³¨æ„ï¼š
# - Tauri CLI 2.9+ çš„ --no-sign æ ‡å¿—ä»…é€‚ç”¨äºŽæ¡Œé¢å¹³å°ï¼ˆWindows/macOS/Linuxï¼‰
# - iOS æž„å»ºé€šè¿‡ xcodebuild å‚æ•°ç¦ç”¨ä»£ç ç­¾åï¼ˆä¸ç›´æŽ¥ä¿®æ”¹ pbxprojï¼‰
# - æž„å»ºè¾“å‡ºæ ‡å‡†æ— ç­¾å IPAï¼Œå¯é€šè¿‡ AltStore/çˆ±æ€åŠ©æ‰‹å®‰è£…

on:
  workflow_dispatch:
  push:
    branches: [ main, master ]
    paths:
      - 'src-tauri/**'
      - 'src/**'
      - '.github/workflows/tauri-ios.yml'

permissions:
  contents: write

jobs:
  build-ios:
    runs-on: macos-14
    
    env:
      TAURI_PROJECT_NAME: "aetherlink"
      IPA_OUTPUT_NAME: "AetherLink-iOS-unsigned.ipa"
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
      
      - name: Setup Rust
        uses: dtolnay/rust-toolchain@stable
        with:
          targets: aarch64-apple-ios,x86_64-apple-ios,aarch64-apple-ios-sim
      
      - name: Rust cache
        uses: swatinem/rust-cache@v2
        with:
          workspaces: './src-tauri -> target'
      
      - name: Setup Xcode
        uses: maxim-lobanov/setup-xcode@v1
        with:
          xcode-version: '16.1'  # é¡¹ç›®æ ¼å¼ 77 éœ€è¦ Xcode 16+ï¼Œä½¿ç”¨å¯ç”¨çš„ 16.1  

      - name: Install dependencies
        run: npm ci || npm install --legacy-peer-deps
      
      - name: Build frontend
        run: npm run build
      
      - name: Verify iOS project exists
        run: |
          # æ£€æŸ¥ iOS é¡¹ç›®æ˜¯å¦å­˜åœ¨ï¼ˆåº”è¯¥å·²ç»åœ¨ä»£ç åº“ä¸­ï¼‰
          if [ -d "src-tauri/gen/apple" ]; then
            echo "âœ… iOS é¡¹ç›®å·²å­˜åœ¨ï¼Œä½¿ç”¨çŽ°æœ‰æºç "
            echo "=== Xcode é¡¹ç›®ä¿¡æ¯ ==="
            ls -la src-tauri/gen/apple/
            find src-tauri/gen/apple -name "*.xcodeproj" -maxdepth 1
          else
            echo "âŒ é”™è¯¯ï¼šiOS é¡¹ç›®ä¸å­˜åœ¨ï¼"
            echo "è¯·å…ˆè¿è¡Œ 'Initialize Tauri iOS Project' workflow åˆå§‹åŒ–é¡¹ç›®"
            echo "æˆ–è€…æ‰‹åŠ¨è¿è¡Œ: npx @tauri-apps/cli ios init"
            exit 1
          fi
      
      - name: Build Rust for iOS (ç¼–è¯‘ Tauri åŽç«¯)
        run: |
          echo "=== ç¼–è¯‘ Tauri Rust ä»£ç  ==="
          # å…ˆç”¨ Tauri CLI ç¼–è¯‘ Rust éƒ¨åˆ†ï¼Œç”Ÿæˆåº“æ–‡ä»¶
          cd src-tauri
          
          # ä¸º iOS çœŸæœºæž¶æž„ç¼–è¯‘
          cargo build --release --target aarch64-apple-ios --lib
          
          echo "âœ… Rust åº“æ–‡ä»¶ç¼–è¯‘å®Œæˆ"
          ls -lh target/aarch64-apple-ios/release/*.a || true
      
      - name: Build iOS App with xcodebuild (ç¦ç”¨ç­¾å)
        run: |
          cd src-tauri/gen/apple
          
          echo "=== ä½¿ç”¨ xcodebuild ç›´æŽ¥æž„å»ºï¼ˆç¦ç”¨ç­¾åï¼‰==="
          
          # ç›´æŽ¥ä½¿ç”¨ xcodebuild æž„å»ºï¼Œä¼ é€’ç­¾åç¦ç”¨å‚æ•°
          xcodebuild archive \
            -project "${TAURI_PROJECT_NAME}.xcodeproj" \
            -scheme "${TAURI_PROJECT_NAME}_iOS" \
            -configuration Release \
            -archivePath ./build/App.xcarchive \
            -destination 'generic/platform=iOS' \
            -sdk iphoneos \
            CODE_SIGN_IDENTITY="" \
            CODE_SIGNING_REQUIRED=NO \
            CODE_SIGNING_ALLOWED=NO \
            DEVELOPMENT_TEAM="" \
            PROVISIONING_PROFILE="" \
            CODE_SIGN_ENTITLEMENTS="" \
            -allowProvisioningUpdates \
            | tee build.log
          
          # æ£€æŸ¥æž„å»ºç»“æžœ
          if [ -d "./build/App.xcarchive" ]; then
            echo "âœ… Archive æž„å»ºæˆåŠŸ"
            ls -la ./build/App.xcarchive/Products/Applications/
            
            # èŽ·å– .app å¤§å°
            APP_PATH="./build/App.xcarchive/Products/Applications/AetherLink.app"
            if [ -d "$APP_PATH" ]; then
              APP_SIZE=$(du -sh "$APP_PATH" | awk '{print $1}')
              echo "APP_SIZE=$APP_SIZE" >> $GITHUB_ENV
              echo ".app å¤§å°: $APP_SIZE"
            fi
          else
            echo "âŒ Archive æž„å»ºå¤±è´¥"
            tail -100 build.log
            exit 1
          fi
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      
      - name: Package Unsigned IPA (æ ‡å‡†æµç¨‹)
        run: |
          echo "=== ä»Ž xcarchive æ‰“åŒ…æ— ç­¾å IPA ==="
          
          APP_PATH="src-tauri/gen/apple/build/App.xcarchive/Products/Applications/AetherLink.app"
          OUTPUT_DIR="ios-artifacts"
          mkdir -p "$OUTPUT_DIR"
          
          # éªŒè¯ .app å­˜åœ¨
          if [ ! -d "$APP_PATH" ]; then
            echo "âŒ .app æ–‡ä»¶ä¸å­˜åœ¨: $APP_PATH"
            echo "æŸ¥æ‰¾å¯èƒ½çš„ .app ä½ç½®ï¼š"
            find src-tauri/gen/apple -name "*.app" -type d || true
            exit 1
          fi
          
          echo "âœ… æ‰¾åˆ° .app: $APP_PATH"
          
          # åˆ›å»ºæ ‡å‡† IPA ç»“æž„ï¼šPayload ç›®å½•
          PAYLOAD_DIR="${OUTPUT_DIR}/Payload"
          mkdir -p "$PAYLOAD_DIR"
          
          # å¤åˆ¶ .app åˆ° Payloadï¼ˆä¿æŒå®Œæ•´ç›®å½•ç»“æž„ï¼‰
          echo "å¤åˆ¶ .app åˆ° Payload..."
          cp -R "$APP_PATH" "$PAYLOAD_DIR/"
          
          # ä¿®å¤ .app æƒé™ï¼ˆé¿å…å®‰è£…å¤±è´¥ï¼‰
          echo "ä¿®å¤æ–‡ä»¶æƒé™..."
          chmod -R 755 "$PAYLOAD_DIR/AetherLink.app"
          find "$PAYLOAD_DIR/AetherLink.app" -type f -exec chmod 644 {} \;
          find "$PAYLOAD_DIR/AetherLink.app" -type d -exec chmod 755 {} \;
          
          # æ‰“åŒ…ä¸º IPAï¼ˆä½¿ç”¨ zipï¼Œ-r é€’å½’ï¼Œ-q å®‰é™æ¨¡å¼ï¼‰
          echo "æ‰“åŒ… IPA..."
          cd "$OUTPUT_DIR"
          zip -r -q "${IPA_OUTPUT_NAME}" Payload/
          
          # æ¸…ç†ä¸´æ—¶ Payload ç›®å½•
          rm -rf Payload/
          
          # éªŒè¯ IPA
          if [ -f "${IPA_OUTPUT_NAME}" ]; then
            IPA_SIZE=$(du -sh "${IPA_OUTPUT_NAME}" | awk '{print $1}')
            echo "IPA_SIZE=$IPA_SIZE" >> $GITHUB_ENV
            echo "âœ… æ— ç­¾å IPA åˆ›å»ºæˆåŠŸ"
            echo "æ–‡ä»¶å: ${IPA_OUTPUT_NAME}"
            echo "å¤§å°: $IPA_SIZE"
            
            # æ˜¾ç¤º IPA ç»“æž„
            echo ""
            echo "=== IPA å†…å®¹é¢„è§ˆ ==="
            unzip -l "${IPA_OUTPUT_NAME}" | head -30
          else
            echo "âŒ IPA æ‰“åŒ…å¤±è´¥"
            exit 1
          fi
      
      - name: Upload Unsigned IPA
        uses: actions/upload-artifact@v4
        with:
          name: tauri-ios-unsigned-ipa
          path: ios-artifacts/${{ env.IPA_OUTPUT_NAME }}
          if-no-files-found: error
          retention-days: 30
      
      - name: Generate Build Summary
        if: always()
        run: |
          echo "## ðŸŽ Tauri iOS æ— ç­¾åæž„å»ºç»“æžœ" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| é¡¹ç›® | è¯¦æƒ… |" >> $GITHUB_STEP_SUMMARY
          echo "|------|------|" >> $GITHUB_STEP_SUMMARY
          echo "| ðŸ“¦ äº§ç‰©åç§° | ${{ env.IPA_OUTPUT_NAME }} |" >> $GITHUB_STEP_SUMMARY
          echo "| ðŸ“Š IPA å¤§å° | ${{ env.IPA_SIZE || 'æœªçŸ¥' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| ðŸ“± .app å¤§å° | ${{ env.APP_SIZE || 'æœªçŸ¥' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| ðŸ”– ç‰ˆæœ¬ | ${{ github.sha }} |" >> $GITHUB_STEP_SUMMARY
          echo "| ðŸŒ¿ åˆ†æ”¯ | ${{ github.ref_name }} |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸ“ è¯´æ˜Ž" >> $GITHUB_STEP_SUMMARY
          echo "- âš ï¸ è¯¥ IPA ä¸º**æ— ç­¾åç‰ˆæœ¬**ï¼Œä»…ç”¨äºŽæµ‹è¯•/å†…éƒ¨åˆ†å‘" >> $GITHUB_STEP_SUMMARY
          echo "- ðŸ”§ å®‰è£…æ–¹å¼ï¼šAltStoreã€SideStoreã€çˆ±æ€åŠ©æ‰‹ã€PPåŠ©æ‰‹ç­‰" >> $GITHUB_STEP_SUMMARY
          echo "- ðŸš« **æ— æ³•**é€šè¿‡ App Store æˆ– TestFlight å®‰è£…" >> $GITHUB_STEP_SUMMARY
          echo "- ðŸ“² æ”¯æŒè®¾å¤‡ï¼šiOS 13.0+" >> $GITHUB_STEP_SUMMARY