name: Tauri iOS Build

on:
  push:
    branches: [ main, master ]
  workflow_dispatch:

permissions:
  contents: write

jobs:
  build-ios:
    runs-on: macos-14
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
      
      - name: Setup Rust
        uses: dtolnay/rust-toolchain@stable
        with:
          targets: aarch64-apple-ios,x86_64-apple-ios,aarch64-apple-ios-sim
      
      - name: Rust cache
        uses: swatinem/rust-cache@v2
        with:
          workspaces: './src-tauri -> target'
      
      - name: Setup Xcode
        uses: maxim-lobanov/setup-xcode@v1
        with:
          xcode-version: '16.1'  # 项目格式 77 需要 Xcode 16+，使用可用的 16.1  

      - name: Install dependencies
        run: npm ci || npm install --legacy-peer-deps
      
      - name: Build frontend
        run: npm run build
      
      - name: Verify iOS project exists
        run: |
          # 检查 iOS 项目是否存在（应该已经在代码库中）
          if [ -d "src-tauri/gen/apple" ]; then
            echo "✅ iOS 项目已存在，使用现有源码"
            echo "=== Xcode 项目信息 ==="
            ls -la src-tauri/gen/apple/
            find src-tauri/gen/apple -name "*.xcodeproj" -maxdepth 1
          else
            echo "❌ 错误：iOS 项目不存在！"
            echo "请先运行 'Initialize Tauri iOS Project' workflow 初始化项目"
            echo "或者手动运行: npx @tauri-apps/cli ios init"
            exit 1
          fi
      
      - name: Build iOS App with Tauri CLI (using --no-sign)
        run: |
          # 使用 Tauri 2.9+ 的 --no-sign 标志跳过代码签名
          echo "=== 使用 --no-sign 标志构建 iOS ==="
          npm run tauri ios build -- --ci --no-sign
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      
      - name: Find and package IPA
        run: |
          echo "=== 查找构建产物 ==="
          find src-tauri/gen/apple -name "*.ipa" -type f || echo "未找到 IPA 文件"
          find src-tauri/gen/apple -name "*.app" -type d | head -5 || echo "未找到 APP 文件"
          
          # 创建输出目录
          mkdir -p ios-artifacts
          
          # 优先查找 IPA 文件
          IPA_FILE=$(find src-tauri/gen/apple -name "*.ipa" -type f | head -n 1)
          
          if [ -n "$IPA_FILE" ] && [ -f "$IPA_FILE" ]; then
            echo "✅ 找到 IPA: $IPA_FILE"
            cp "$IPA_FILE" ios-artifacts/AetherLink-iOS.ipa
            ls -lh ios-artifacts/AetherLink-iOS.ipa
          else
            echo "⚠️ 未找到 IPA，从 .app 创建"
            
            # 查找 .app 文件（优先从 xcarchive 中查找）
            APP_FILE=$(find src-tauri/gen/apple -path "*/Products/Applications/*.app" -type d | head -n 1)
            
            if [ -z "$APP_FILE" ]; then
              APP_FILE=$(find src-tauri/gen/apple -name "AetherLink.app" -type d | grep -v "Intermediates" | head -n 1)
            fi
            
            if [ -n "$APP_FILE" ] && [ -d "$APP_FILE" ]; then
              echo "✅ 找到 APP: $APP_FILE"
              
              # 创建 Payload 目录并复制 .app
              mkdir -p ios-artifacts/Payload
              cp -r "$APP_FILE" ios-artifacts/Payload/
              
              # 打包为 IPA
              cd ios-artifacts
              zip -r -q AetherLink-iOS.ipa Payload/
              rm -rf Payload/
              
              echo "✅ IPA 创建成功"
              ls -lh AetherLink-iOS.ipa
              
              # 显示 IPA 内容
              echo "=== IPA 内容 ==="
              unzip -l AetherLink-iOS.ipa | head -20
            else
              echo "❌ 无法找到 .app 文件"
              echo "=== 查找所有 .app ==="
              find src-tauri/gen/apple -name "*.app" -type d || true
              exit 1
            fi
          fi
      
      - name: Upload iOS artifacts
        uses: actions/upload-artifact@v4
        with:
          name: tauri-ios-ipa
          path: ios-artifacts/*.ipa
          if-no-files-found: warn
          retention-days: 30
      
      - name: Create build summary
        run: |
          echo "## Tauri iOS " >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### " >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
          ls -lh ios-artifacts/ || echo "" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### " >> $GITHUB_STEP_SUMMARY
          echo "Actions " >> $GITHUB_STEP_SUMMARY