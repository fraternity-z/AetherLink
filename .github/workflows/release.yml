name: Release

on:
  push:
    tags:
      - 'v*'

permissions:
  contents: write

jobs:
  # ============================================================
  # Android APK (Capacitor)
  # ============================================================
  build-android:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '22'
          cache: 'npm'

      - name: Install Dependencies
        env:
          NPM_TOKEN: ${{ secrets.NPM_TOKEN }}
        run: npm ci || npm install --legacy-peer-deps

      - name: Build Web App
        run: npm run build

      - name: Setup JDK 21
        uses: actions/setup-java@v4
        with:
          java-version: '21'
          distribution: 'temurin'
          cache: gradle

      - name: Setup Android SDK
        uses: android-actions/setup-android@v2

      - name: Sync Capacitor
        run: npx cap sync android

      - name: Grant execute permission for gradlew
        run: chmod +x ./android/gradlew

      - name: Create keystore.properties
        run: |
          echo "storeFile=aetherlink.keystore" > android/keystore.properties
          echo "storePassword=aetherlink2025" >> android/keystore.properties
          echo "keyAlias=aetherlink" >> android/keystore.properties
          echo "keyPassword=aetherlink2025" >> android/keystore.properties

      - name: Build Release APK
        run: cd android && ./gradlew assembleRelease

      - name: Rename APK
        run: |
          VERSION=${GITHUB_REF#refs/tags/v}
          cp android/app/build/outputs/apk/release/app-release.apk \
             android/app/build/outputs/apk/release/AetherLink-${VERSION}-android.apk

      - name: Upload Artifact
        uses: actions/upload-artifact@v4
        with:
          name: android-apk
          path: android/app/build/outputs/apk/release/AetherLink-*-android.apk

  # ============================================================
  # iOS IPA (Capacitor, unsigned)
  # ============================================================
  build-ios:
    runs-on: macos-14
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '22'
          cache: 'npm'

      - name: Install Dependencies
        env:
          NPM_TOKEN: ${{ secrets.NPM_TOKEN }}
        run: npm ci || npm install --legacy-peer-deps

      - name: Build Web App
        run: npm run build

      - name: Setup Xcode
        uses: maxim-lobanov/setup-xcode@v1
        with:
          xcode-version: '15.4'

      - name: Install CocoaPods
        run: sudo gem install cocoapods

      - name: Sync Capacitor iOS
        run: npx cap sync ios

      - name: Install CocoaPods dependencies
        run: cd ios/App && pod install --repo-update

      - name: Disable Code Signing
        run: |
          cd ios/App
          python3 - << 'EOF'
          import re
          with open("App.xcodeproj/project.pbxproj", "r") as f:
              content = f.read()
          content = re.sub(r'CODE_SIGN_STYLE = Automatic;', 'CODE_SIGN_STYLE = Manual;', content)
          content = re.sub(r'DEVELOPMENT_TEAM = [^;]*;', 'DEVELOPMENT_TEAM = "";', content)
          content = re.sub(r'CODE_SIGN_IDENTITY = [^;]*;', 'CODE_SIGN_IDENTITY = "";', content)
          content = re.sub(r'PROVISIONING_PROFILE_SPECIFIER = [^;]*;', 'PROVISIONING_PROFILE_SPECIFIER = "";', content)
          if 'CODE_SIGNING_ALLOWED' not in content:
              content = re.sub(r'(buildSettings = \{[^}]*)', r'\1\n\t\t\t\tCODE_SIGNING_ALLOWED = NO;', content)
          with open("App.xcodeproj/project.pbxproj", "w") as f:
              f.write(content)
          EOF

      - name: Build iOS Archive
        run: |
          cd ios/App
          xcodebuild archive \
            -workspace App.xcworkspace \
            -scheme App \
            -configuration Release \
            -archivePath ./build/App.xcarchive \
            -destination generic/platform=iOS \
            CODE_SIGNING_ALLOWED=NO \
            CODE_SIGN_IDENTITY="" \
            PROVISIONING_PROFILE="" \
            DEVELOPMENT_TEAM="" \
            SWIFT_OPTIMIZATION_LEVEL="-Onone" \
            -quiet

      - name: Create IPA
        run: |
          cd ios/App
          VERSION=${GITHUB_REF#refs/tags/v}
          mkdir -p ./build/Payload
          cp -r ./build/App.xcarchive/Products/Applications/*.app ./build/Payload/
          cd ./build
          zip -r AetherLink-${VERSION}-ios-unsigned.ipa Payload/

      - name: Upload Artifact
        uses: actions/upload-artifact@v4
        with:
          name: ios-ipa
          path: ios/App/build/AetherLink-*-ios-unsigned.ipa

  # ============================================================
  # Tauri Desktop (Windows / macOS / Linux)
  # ============================================================
  build-tauri:
    strategy:
      fail-fast: false
      matrix:
        include:
          - platform: 'macos-latest'
            args: '--target universal-apple-darwin --bundles app,dmg'
            target: 'aarch64-apple-darwin,x86_64-apple-darwin'
            artifact-name: 'tauri-macos'
          - platform: 'ubuntu-22.04'
            args: ''
            target: 'x86_64-unknown-linux-gnu'
            artifact-name: 'tauri-linux'
          - platform: 'windows-latest'
            args: ''
            target: 'x86_64-pc-windows-msvc'
            artifact-name: 'tauri-windows'

    runs-on: ${{ matrix.platform }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '22'
          cache: 'npm'

      - name: Setup Rust
        uses: dtolnay/rust-toolchain@stable

      - name: Add Rust targets (Unix)
        if: matrix.platform != 'windows-latest'
        run: |
          IFS=',' read -ra TARGETS <<< "${{ matrix.target }}"
          for target in "${TARGETS[@]}"; do
            rustup target add "$target"
          done

      - name: Add Rust targets (Windows)
        if: matrix.platform == 'windows-latest'
        run: |
          $targets = "${{ matrix.target }}" -split ","
          foreach ($target in $targets) {
            rustup target add $target.Trim()
          }

      - name: Rust Cache
        uses: swatinem/rust-cache@v2
        with:
          workspaces: './src-tauri -> target'

      - name: Install Linux Dependencies
        if: matrix.platform == 'ubuntu-22.04'
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            libgtk-3-dev libwebkit2gtk-4.0-dev libayatana-appindicator3-dev \
            librsvg2-dev libssl-dev libxdo-dev libsoup-3.0-dev \
            libjavascriptcoregtk-4.0-dev libwebkit2gtk-4.1-dev libgtk-4-dev \
            build-essential curl wget file libxcb-shape0-dev libxcb-xfixes0-dev pkg-config

      - name: Install macOS Dependencies
        if: matrix.platform == 'macos-latest'
        run: brew install create-dmg

      - name: Setup WiX Toolset (Windows)
        if: matrix.platform == 'windows-latest'
        run: |
          if (!(Get-Command candle.exe -ErrorAction SilentlyContinue)) {
            choco install wixtoolset -y --no-progress
          }
          $wixPath = (Get-ChildItem "C:\Program Files (x86)\WiX Toolset*\bin" -ErrorAction SilentlyContinue | Select-Object -First 1).FullName
          if ($wixPath) { echo $wixPath >> $env:GITHUB_PATH }
        shell: pwsh

      - name: Install Dependencies
        env:
          NPM_TOKEN: ${{ secrets.NPM_TOKEN }}
        run: npm ci || npm install --legacy-peer-deps

      - name: Build Frontend
        run: npm run build

      - name: Install Tauri CLI
        run: npm install -g @tauri-apps/cli@latest

      - name: Build Tauri App
        run: |
          cd src-tauri
          if [ "${{ matrix.platform }}" = "macos-latest" ]; then
            export APPLE_SIGNING_IDENTITY="-"
          fi
          tauri build ${{ matrix.args }}
        shell: bash

      # --- Upload per-platform artifacts ---
      - name: Upload Windows Artifacts
        if: matrix.platform == 'windows-latest'
        uses: actions/upload-artifact@v4
        with:
          name: ${{ matrix.artifact-name }}
          path: |
            src-tauri/target/release/bundle/msi/*.msi
            src-tauri/target/release/bundle/nsis/*.exe

      - name: Upload macOS Artifacts
        if: matrix.platform == 'macos-latest'
        uses: actions/upload-artifact@v4
        with:
          name: ${{ matrix.artifact-name }}
          path: |
            src-tauri/target/universal-apple-darwin/release/bundle/dmg/*.dmg

      - name: Upload Linux Artifacts
        if: matrix.platform == 'ubuntu-22.04'
        uses: actions/upload-artifact@v4
        with:
          name: ${{ matrix.artifact-name }}
          path: |
            src-tauri/target/release/bundle/appimage/*.AppImage
            src-tauri/target/release/bundle/deb/*.deb

  # ============================================================
  # æ±‡æ€»æ‰€æœ‰äº§ç‰© â†’ åˆ›å»º GitHub Release
  # ============================================================
  publish-release:
    needs: [build-android, build-ios, build-tauri]
    runs-on: ubuntu-latest
    steps:
      - name: Checkout (for changelog)
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Download All Artifacts
        uses: actions/download-artifact@v4
        with:
          path: release-assets
          merge-multiple: false

      - name: List downloaded files
        run: find release-assets -type f | head -50

      - name: Flatten artifacts into one folder
        run: |
          mkdir -p final-assets
          find release-assets -type f \( \
            -name "*.apk" -o -name "*.ipa" -o \
            -name "*.dmg" -o -name "*.msi" -o -name "*.exe" -o \
            -name "*.AppImage" -o -name "*.deb" \
          \) -exec cp {} final-assets/ \;
          echo "=== Release assets ==="
          ls -lh final-assets/

      - name: Generate Changelog
        id: changelog
        run: |
          # è·å–ä¸Šä¸€ä¸ª tag
          PREV_TAG=$(git tag --sort=-creatordate | grep '^v' | sed -n '2p')
          CURRENT_TAG=${GITHUB_REF#refs/tags/}

          if [ -n "$PREV_TAG" ]; then
            echo "Generating changelog from $PREV_TAG to $CURRENT_TAG"
            LOG=$(git log --pretty=format:"- %s (%h)" "$PREV_TAG".."$CURRENT_TAG" -- . ':!docs' ':!*.md' 2>/dev/null || echo "- Initial release")
          else
            LOG="- Initial release"
          fi

          # å†™å…¥å¤šè¡Œè¾“å‡º
          echo "log<<EOF" >> $GITHUB_OUTPUT
          echo "$LOG" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ github.ref_name }}
          name: AetherLink ${{ github.ref_name }}
          body: |
            ## AetherLink ${{ github.ref_name }}

            ### ğŸ“¦ ä¸‹è½½

            | å¹³å° | æ–‡ä»¶ |
            |------|------|
            | ğŸ¤– Android | `.apk` |
            | ğŸ iOS | `.ipa` (æœªç­¾åï¼Œéœ€ AltStore/SideStore å®‰è£…) |
            | ğŸªŸ Windows | `.msi` / `.exe` |
            | ğŸ macOS | `.dmg` |
            | ğŸ§ Linux | `.AppImage` / `.deb` |

            ### ğŸ“ æ›´æ–°å†…å®¹
            ${{ steps.changelog.outputs.log }}
          files: final-assets/*
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
