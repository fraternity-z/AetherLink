name: Android Build

on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]
  workflow_dispatch:

permissions:
  contents: write
  packages: write

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '22'
          cache: 'npm'

      - name: Clear npm cache
        run: npm cache clean --force

      - name: Install Dependencies with retry
        run: |
          # å°è¯•å¤šç§æ–¹æ³•å®‰è£…ä¾èµ–
          echo "Attempting npm ci..."
          npm ci || {
            echo "npm ci failed, trying alternative approaches..."
            echo "Cleaning up and retrying..."
            rm -rf node_modules package-lock.json
            npm cache clean --force

            echo "Trying npm install with --no-package-lock..."
            npm install --no-package-lock || {
              echo "npm install failed, trying with --legacy-peer-deps..."
              npm install --legacy-peer-deps || {
                echo "All npm methods failed, trying yarn as fallback..."
                npm install -g yarn
                yarn install --ignore-engines
              }
            }
          }

      - name: Build Web App
        run: npm run build

      - name: Set up JDK 21
        uses: actions/setup-java@v4
        with:
          java-version: '21'
          distribution: 'temurin'
          cache: gradle

      - name: Set up Android SDK
        uses: android-actions/setup-android@v2

      - name: Clean Android Build Cache
        run: |
          echo "Cleaning Android build cache to avoid duplicate class issues..."
          rm -rf android/.gradle
          rm -rf android/app/build
          rm -rf android/capacitor-cordova-android-plugins/build
          rm -rf ~/.gradle/caches/transforms-*
          echo "Build cache cleaned"

      - name: Sync Capacitor
        run: npx cap sync android

      - name: Grant execute permission for gradlew
        run: chmod +x ./android/gradlew

      - name: Setup Signing Keystore
        run: |
          # æ£€æŸ¥æ˜¯å¦å­˜åœ¨ç­¾åå¯†é’¥æ–‡ä»¶
          if [ -f "android/aetherlink.keystore" ]; then
            echo "Keystore file found in repository"
            export KEYSTORE_FILE="${{ github.workspace }}/android/aetherlink.keystore"
          else
            echo "Creating keystore from secrets or generating new one..."
            # å¦‚æœæœ‰ KEYSTORE_BASE64 secretï¼Œåˆ™è§£ç ä½¿ç”¨
            if [ -n "${{ secrets.KEYSTORE_BASE64 }}" ]; then
              echo "${{ secrets.KEYSTORE_BASE64 }}" | base64 -d > android/aetherlink.keystore
            else
              # ç”Ÿæˆæ–°çš„ keystoreï¼ˆç”¨äºæµ‹è¯•æ„å»ºï¼‰
              keytool -genkey -v \
                -keystore android/aetherlink.keystore \
                -alias aetherlink \
                -keyalg RSA \
                -keysize 2048 \
                -validity 10000 \
                -storepass aetherlink2025 \
                -keypass aetherlink2025 \
                -dname "CN=AetherLink, OU=Development, O=LLMHouse, L=Unknown, ST=Unknown, C=CN"
            fi
          fi
          echo "Keystore ready"

      - name: Create keystore.properties
        run: |
          cat > android/keystore.properties << EOF
          storeFile=aetherlink.keystore
          storePassword=${{ secrets.KEYSTORE_PASSWORD || 'aetherlink2025' }}
          keyAlias=${{ secrets.KEY_ALIAS || 'aetherlink' }}
          keyPassword=${{ secrets.KEY_PASSWORD || 'aetherlink2025' }}
          EOF

      - name: Build Debug APK
        run: cd android && ./gradlew assembleDebug
        env:
          KEYSTORE_FILE: ${{ github.workspace }}/android/aetherlink.keystore
          KEYSTORE_PASSWORD: ${{ secrets.KEYSTORE_PASSWORD || 'aetherlink2025' }}
          KEY_ALIAS: ${{ secrets.KEY_ALIAS || 'aetherlink' }}
          KEY_PASSWORD: ${{ secrets.KEY_PASSWORD || 'aetherlink2025' }}

      - name: Build Release APK
        run: cd android && ./gradlew assembleRelease
        env:
          KEYSTORE_FILE: ${{ github.workspace }}/android/aetherlink.keystore
          KEYSTORE_PASSWORD: ${{ secrets.KEYSTORE_PASSWORD || 'aetherlink2025' }}
          KEY_ALIAS: ${{ secrets.KEY_ALIAS || 'aetherlink' }}
          KEY_PASSWORD: ${{ secrets.KEY_PASSWORD || 'aetherlink2025' }}

      - name: Upload Debug APK
        uses: actions/upload-artifact@v4
        with:
          name: app-debug
          path: android/app/build/outputs/apk/debug/app-debug.apk

      - name: Upload Release APK
        uses: actions/upload-artifact@v4
        with:
          name: app-release
          path: android/app/build/outputs/apk/release/app-release.apk

      - name: Get current date
        id: date
        run: echo "date=$(date +'%Y%m%d-%H%M%S')" >> $GITHUB_OUTPUT

      # æ³¨é‡Šæ‰è‡ªåŠ¨å‘å¸ƒåŠŸèƒ½ï¼Œé¿å…äº§ç”Ÿè¿‡å¤šçš„ releases
      # - name: Create Release
      #   if: (github.ref == 'refs/heads/main' || github.ref == 'refs/heads/master') && github.event_name == 'push'
      #   uses: softprops/action-gh-release@v2
      #   with:
      #     tag_name: android-v${{ steps.date.outputs.date }}
      #     name: Android Build ${{ steps.date.outputs.date }}
      #     body: |
      #       ğŸ¤– è‡ªåŠ¨æ„å»ºçš„ Android APK
      #
      #       ğŸ“± **æ„å»ºä¿¡æ¯**ï¼š
      #       - æ„å»ºæ—¶é—´ï¼š${{ steps.date.outputs.date }}
      #       - æäº¤ï¼š${{ github.sha }}
      #       - åˆ†æ”¯ï¼š${{ github.ref_name }}
      #
      #       ğŸ“¦ **ä¸‹è½½**ï¼š
      #       - ä¸‹è½½ APK æ–‡ä»¶å¹¶å®‰è£…åˆ° Android è®¾å¤‡
      #
      #       âš ï¸ **æ³¨æ„**ï¼š
      #       - è¿™æ˜¯ Debug ç‰ˆæœ¬ï¼Œä»…ç”¨äºæµ‹è¯•
      #       - é¦–æ¬¡å®‰è£…éœ€è¦å…è®¸"æœªçŸ¥æ¥æº"åº”ç”¨å®‰è£…
      #       - åœ¨è®¾ç½® > å®‰å…¨ > æœªçŸ¥æ¥æº ä¸­å¯ç”¨
      #
      #       ğŸ”§ **å®‰è£…æ­¥éª¤**ï¼š
      #       1. ä¸‹è½½ APK æ–‡ä»¶åˆ° Android è®¾å¤‡
      #       2. åœ¨è®¾ç½®ä¸­å¯ç”¨"æœªçŸ¥æ¥æº"åº”ç”¨å®‰è£…
      #       3. ç‚¹å‡» APK æ–‡ä»¶è¿›è¡Œå®‰è£…
      #     files: |
      #       android/app/build/outputs/apk/debug/app-debug.apk
      #     draft: false
      #     prerelease: true
      #   env:
      #     GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}